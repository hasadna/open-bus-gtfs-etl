- name: gtfs-etl
  schedule_interval: "@daily"
  description: |
    Load GTFS data to DB
  tasks:
    - id: download_extract
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: download_extract
        kwargs:
          from_mot: {default: true}
          from_stride: {default: false}
          date: {}
          force_download: {}
          num_retries: {default: 10}
          retry_sleep_seconds: {default: 120}
    - id: load_stops_to_db
      depends_on:
        - download_extract
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_stops_to_db
        kwargs:
          date: {}
    - id: load_routes_to_db
      depends_on:
        - download_extract
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_routes_to_db
        kwargs:
          date: {}
    - id: load_trips_to_db
      depends_on:
        - load_routes_to_db
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_trips_to_db
        kwargs:
          date: {}
    - id: load_stop_times_to_db
      depends_on:
        - load_trips_to_db
        - load_stops_to_db
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_stop_times_to_db
        kwargs:
          date: {}
          limit: {}
          debug: {}
    - id: cleanup-dated-paths
      depends_on:
        - download_extract
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: cleanup_dated_paths
        kwargs:
          num_days_keep: {default: 10}
          num_weeklies_keep: {default: 10}
    - id: trigger-stride-etl-gtfs-update-ride-aggregations-dag
      depends_on:
        - load_stops_to_db
        - load_routes_to_db
        - load_trips_to_db
        - load_stop_times_to_db
      config:
        type: trigger_dag
        trigger_dag_id: stride-etl-gtfs-update-ride-aggregations
        pass_conf_params: [date]
    - id: cleanup_workdir
      depends_on:
        - trigger-stride-etl-gtfs-update-ride-aggregations-dag
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: cleanup_workdir
        kwargs:
          date: {}
