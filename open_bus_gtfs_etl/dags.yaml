- name: gtfs-etl
  schedule_interval: "@daily"
  description: |
    Load GTFS data to DB
  tasks:
    - id: download
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: download
        kwargs:
          date: {}
          force_download: {}
    - id: extract
      depends_on:
        - download
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: extract
        kwargs:
          date: {}
          workdir: {}
    - id: load_stops_to_db
      depends_on:
        - extract
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_stops_to_db
        kwargs:
          date: {}
          workdir: {}
    - id: load_routes_to_db
      depends_on:
        - extract
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_routes_to_db
        kwargs:
          date: {}
          workdir: {}
    - id: load_trips_to_db
      depends_on:
        - load_routes_to_db
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_trips_to_db
        kwargs:
          date: {}
          workdir: {}
    - id: load_stop_times_to_db
      depends_on:
        - load_trips_to_db
        - load_stops_to_db
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: load_stop_times_to_db
        kwargs:
          date: {}
          workdir: {}
          limit: {}
          debug: {}
    - id: cleanup-dated-paths
      depends_on:
        - download
      config:
        type: cli
        module: open_bus_gtfs_etl.cli
        function: cleanup_dated_paths
        kwargs:
          num_days_keep: {default: 10}
          num_weeklies_keep: {default: 10}
    - id: trigger-stride-etl-gtfs-update-ride-aggregations-dag
      depends_on:
        - load_stop_times_to_db
      config:
        type: trigger_dag
        trigger_dag_id: stride-etl-gtfs-update-ride-aggregations
        pass_conf_params: [date]
